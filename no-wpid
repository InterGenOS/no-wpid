#!/bin/bash
# wp - simple script to null/enable WordPress readme.html and license.txt files on a cPanel server
# InterGen 5/12/15

function RED {
tput bold
tput setaf 1
}
function GREEN {
tput bold
tput setaf 2
}
function YELLOW {
tput bold
tput setaf 3
}
function BLUE {
tput bold
tput setaf 4
}
function SEPARATOR {
YELLOW
echo
echo "----------------------------"
echo
}
function SEPARATOR_WHITE {
tput sgr0
echo "------------------------------------------------------------------"
}
function BLOCK {
    if [ -f /home/"$USR"/public_html/readme.html ]; then
        SEPARATOR
        BLUE
        printf "Checking for WordPress Identifiers in account "
        tput sgr0
        printf "\"$USR\"\n"
        echo
        YELLOW
        printf "Blocking all "
        tput sgr0
        printf "'readme.*'"
        YELLOW
        printf " and "
        tput sgr0
        printf "'license.*'"
        YELLOW
        printf " files now...\n"
        sleep 1
        for identifier in $(find /home/"$USR"/public_html -type f -name "LICENSE.*" -o -name "license.*" -o -name "readme.*" -o -name "README.*"); 
do chown nobody:nobody "$identifier" && chmod 000 "$identifier" && sleep 1; done
        echo
        GREEN
        printf "WordPress Indentifiers have been blocked for account "
        tput sgr0
        printf "\"$USR\"\n"
        SEPARATOR
        tput sgr0
    else
        BLUE
        printf "Checking for WordPress Identifiers in account "
        tput sgr0
        printf "\"$USR\"\n"
        echo
        RED
        printf "No "
        tput sgr0
        printf "readme.*"
        RED
        printf " or "
        tput sgr0
        printf "license.*"
        RED
        printf " files found, skipping account "
        tput sgr0
        printf "\"$USR\"...\n"
        SEPARATOR
        tput sgr0
    fi
}
function UNBLOCK {
    if [ -f /home/"$USR"/public_html/readme.html ]; then
        SEPARATOR
        BLUE
        printf "Checking for WordPress Identifiers in account "
        tput sgr0
        printf "\"$USR\"\n"
        echo
        YELLOW
        printf "Unblocking "
        tput sgr0
        printf "'readme.*'"
        YELLOW
        printf " and "
        tput sgr0
        printf "'license.*'"
        YELLOW
        printf " files now...\n"
        sleep 1
        for identifier in $(find /home/"$USR"/public_html -type f -name "LICENSE.*" -o -name "license.*" -o -name "readme.*" -o -name "README.*"); 
do chown "$USR":"$USR" "$identifier" && chmod 644 "$identifier" && sleep 1; done
        echo
        GREEN
        printf "WordPress Indentifiers have been unblocked for account "
        tput sgr0
        printf "\"$USR\"\n"
        SEPARATOR
        tput sgr0
    else
        BLUE
        printf "Checking for WordPress Identifiers in account "
        tput sgr0
        printf "\"$USR\"\n"
        echo
        RED
        printf "No "
        tput sgr0
        printf "readme.*"
        RED
        printf " or "
        tput sgr0
        printf "license.*"
        RED
        printf " files found, skipping account "
        tput sgr0
        printf "\"$USR\"...\n"
        SEPARATOR
        tput sgr0
    fi
}
function ALL_USERS {
clear
printf "\n\n"
SEPARATOR_WHITE
echo
GREEN
printf "Ok, are we "
tput sgr0
printf "1)'Blocking'"
GREEN
printf " or "
tput sgr0
printf "2)'Unblocking'"
GREEN
printf " WordPress Identifiers "
tput sgr0
echo -n "[1/2]? "
old_stty_cfg=$(stty -g)
stty raw -echo
CHOICE=$( while ! head -c 1 | grep -i '[12]' ;do true ;done )
stty $old_stty_cfg
if echo "$CHOICE" | grep -iq "1" ;then
    printf "\n\n"
    for USR in $(grep \: /etc/userdomains | grep -v nobody | awk '{print $2}' | uniq); do BLOCK; done
else
    printf "\n\n"
    for USR in $(grep \: /etc/userdomains | grep -v nobody | awk '{print $2}' | uniq); do UNBLOCK; done
fi
}
function SINGLE_USER {
clear
printf "\n\n"
SEPARATOR_WHITE
echo
GREEN
echo "Which account are we adjusting WordPress Identifiers for? "
SEPARATOR
tput sgr0
grep \: /etc/userdomains | grep -v nobody | awk '{print $2}' | uniq
SEPARATOR
tput sgr0
printf "["
GREEN
printf "enter account name"
tput sgr0
printf "]"
echo -n ":"
read USR
if [ "$USR" != "$(grep "$USR" /etc/passwd | cut -d ':' -f 1)" ]; then
    echo
    SEPARATOR
    tput sgr0
    printf "\"$USR\""
    RED
    printf " isn't a valid user on this server, Sparky... run it again...\n"
    echo
    SEPARATOR
    exit 0
else
    clear
    SEPARATOR_WHITE
    GREEN
    echo
    printf "Ok, are we "
    tput sgr0
    printf "1)'Blocking'"
    GREEN
    printf " or "
    tput sgr0
    printf "2)'Unblocking'"
    GREEN
    printf " WordPress Identifiers "
    tput sgr0
    echo -n "[1/2]? "
    old_stty_cfg=$(stty -g)
    stty raw -echo
    WHICH=$( while ! head -c 1 | grep -i '[12]' ;do true ;done )
    stty $old_stty_cfg
    if echo "$WHICH" | grep -iq "1" ;then
        printf "\n\n"
        BLOCK "$USR"
    else
        printf "\n\n"
        UNBLOCK "$USR"
    fi
fi
}
clear
printf "\n\n"
SEPARATOR_WHITE
GREEN
echo
printf "Are we adjusting WordPress Identifiers for the entire server "
tput sgr0
echo -n "[y/n]? "
old_stty_cfg=$(stty -g)
stty raw -echo
answer="$( while ! head -c 1 | grep -i '[ny]' ;do true ;done )"
stty $old_stty_cfg
if echo "$answer" | grep -iq "^y" ;then
    echo
    ALL_USERS
else
    echo
    SINGLE_USER
fi
exit 0
